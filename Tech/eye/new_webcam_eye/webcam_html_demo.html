<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live 95% BCEA JSON Logger</title>
  <script src="https://api.gazerecorder.com/GazeCloudAPI.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1 { margin-bottom: .5rem; }
    #status { color: #555; }
  </style>
</head>
<body>
  <h1>FocusLoop – Live 95 % BCEA JSON Logger</h1>
  <p id="status">Initializing GazeCloudAPI…</p>

  <script>
    const WINDOW_MS   = 1000;  // 1 s rolling window
    const INTERVAL_MS = 25;    // 0.025 s intervals
    const CHI2_95     = 5.991; // χ²₀.₉₅,₂

    const buffer = [];

    GazeCloudAPI.UseClickRecalibration = true;

    GazeCloudAPI.OnResult = ({ state, docX, docY }) => {
      const now = Date.now();
      buffer.push({ state, x: docX, y: docY, t: now });
      while (buffer.length && buffer[0].t < now - WINDOW_MS) {
        buffer.shift();
      }
    };

    GazeCloudAPI.OnCalibrationComplete = () => {
      document.getElementById('status').textContent =
        'Calibrated. Tracking…';
    };

    GazeCloudAPI.OnCamDenied = () => {
      document.getElementById('status').textContent =
        'Camera access denied';
    };

    GazeCloudAPI.OnError = msg => console.error('GazeCloudAPI error:', msg);

    function calculateBCEA(points) {
      const valid = points.filter(p => p.state === 0);
      if (valid.length < 2) return null;

      const xs = valid.map(p => p.x),
            ys = valid.map(p => p.y);
      const mx = xs.reduce((s, v) => s + v, 0) / xs.length;
      const my = ys.reduce((s, v) => s + v, 0) / ys.length;

      let vX = 0, vY = 0, cXY = 0;
      for (let i = 0; i < xs.length; i++) {
        const dx = xs[i] - mx, dy = ys[i] - my;
        vX  += dx * dx;
        vY  += dy * dy;
        cXY += dx * dy;
      }
      vX  /= xs.length;
      vY  /= xs.length;
      cXY /= xs.length;

      const det = vX * vY - cXY * cXY;
      if (det <= 0) return 0;

      // 95% BCEA:
      return Math.PI * CHI2_95 * Math.sqrt(det);
    }

    setInterval(() => {
      const nowSec  = Date.now() / 1000;
      const rawBCEA = calculateBCEA(buffer);
      const latest  = buffer[buffer.length - 1] || {};

      const xVal = (latest.state === 0)
        ? Number(latest.x.toFixed(1))
        : null;
      const yVal = (latest.state === 0)
        ? Number(latest.y.toFixed(1))
        : null;
      const bceaVal = (rawBCEA !== null)
        ? Number(rawBCEA.toFixed(2))
        : null;

      const payload = {
        ts:   nowSec,
        x:    xVal,
        y:    yVal,
        bcea: bceaVal
      };
      ws.send(JSON.stringify(payload));
      console.log(JSON.stringify(payload));
    }, INTERVAL_MS);

    GazeCloudAPI.StartEyeTracking();
    // right after GazeCloudAPI.StartEyeTracking();
    const ws = new WebSocket("ws://localhost:8081");
    ws.addEventListener("open",  ()=> console.log("➤ WS→bridge connected"));
    ws.addEventListener("error", e=> console.error("WS error", e));


    document.getElementById('status').textContent =
      'Tracking… click feed to calibrate.';
  </script>
</body>
</html>
